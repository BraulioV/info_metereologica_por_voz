<?xml version="1.0" encoding="UTF-8"?>
<vxml version = "2.1" xml:lang="es-ES">
    <var name="yahoomet" />
    <form id="mainMenu">
        <block bargein="false">
            <prompt>Bienvenido al sistema de información metereológica</prompt>
        </block>
        <!-- En primer lugar le pedimos al usuario que especifique la ciudad -->
        <field name="Ciudad">
            <prompt> 
                Por favor, dime el nombre de una ciudad.
            </prompt>
            <prompt count="2">
                Por favor, dime de nuevo el nombre de la ciudad.
            </prompt>
            <grammar src="ciudades.grammar"/>

        <noinput>
            <prompt>
                No te he oído. Inténtalo de nuevo.
            </prompt>
        </noinput>

        <nomatch>
            <prompt>
                No te he entendido bien.
            </prompt>
            <reprompt/>
        </nomatch>
        </field>
        <field name="confirmacion_ciudad" type="boolean">
            <prompt> ¿Has dicho <value expr="Ciudad"/>? </prompt>
            <grammar>
                SI_NO[
                    [sí]{return("yes")}
                    [no]{return("no")}
                ]
            </grammar>

            <!-- si el usuario dice que no, se le vuelve a pedir la ciudad -->
            <filled>
                <if cond="!confirmacion_ciudad">
                    <clear namelist="Ciudad"/>
                    <clear namelist="confirmacion_ciudad"/>
                    <reprompt/>
                </if>
            </filled>
        </field>
        <!-- Después, le pedimos que especifique el día para el que desea 
        saber la previsión -->
        <field name="Cuando">
            <prompt>
                Ahora dime para qué día deseas saber la previsión.
            </prompt>
            <prompt count="2">
                Repite de nuevo el día para el que deseas saber la previsión.
            </prompt>
            <grammar src="cuando.grammar"/>
            
            <noinput>
                <prompt>
                    No te he oído. Inténtalo de nuevo.
                </prompt>
            </noinput>

            <nomatch>
                <prompt>
                    No te he entendido bien.
                </prompt>
                <reprompt/>
            </nomatch>
        </field>
        <field name="confirmacion_cuando" type="boolean">
            <prompt> ¿Has dicho <value expr="Cuando"/>? </prompt>
            <grammar>
                SI_NO[
                    [sí]{return("yes")}
                    [no]{return("no")}
                ]
            </grammar>

            <!-- si el usuario dice que no, se le vuelve a pedir la cuando -->
            <filled>
                <if cond="!confirmacion_cuando">
                    <clear namelist="Cuando"/>
                    <clear namelist="confirmacion_cuando"/>
                    <reprompt/>
                </if>
            </filled>                
        </field>
        <!-- Una vez obtenida la información clave, pasamos a decirle al usuario
        la previsión metereológica -->
        <!-- <var name="querymet" expr="'('+Ciudad+',spain)'"/>
        <log expr="'Query = ' + querymet" />
        <data name="yahoomet" srcexpr="'https://query.yahooapis.com/v1/public/yql?q=select * from weather.forecast where woeid in (select woeid from geo.places where text='+querymet"/> -->
        <!-- Script que obtiene el woeid de una ciudad dada -->
        <script>
            <![CDATA[
            function Get(city){
                var Httpreq = new XMLHttpRequest(); 
                var dir = "https://query.yahooapis.com/v1/public/yql?q=";
                var q = "select woeid from geo.places(1) where text=";
                var c = "(" + city + ", spain)";
                var get_q = dir + q + "'" + c + "'" + "&format=json";
                Httpreq.open("GET",get_q,false);
                Httpreq.send(null);
                var res_json = JSON.parse(Httpreq.responseText);
                return res_json.query.results.place.woeid
            }
            ]]>
        </script>
        <var name="idcity" expr="Get(Ciudad)"/>
        <log expr="'WOEID = ' + idcity" />
    </form>
</vxml>
